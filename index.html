<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBM 안전 점검 및 관리자 스크립트</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Inter 폰트 사용 설정 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styles for professional look */
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 12px;
        }
        /* General Checklist Item Styling */
        .general-checklist-item, .job-checklist-item {
            transition: all 0.3s ease;
            user-select: none; /* Prevent text selection on click */
        }
        .general-checklist-item.checked {
            background-color: #d1fae5; /* Green 100 */
        }
        .general-checklist-item:hover, .job-checklist-item:hover {
            background-color: #e5e7eb; /* Gray 200 */
        }
        /* Job Checklist Item Styling */
        .job-checklist-item.checked {
            background-color: #ffe4e6; /* Red 100 for focused hazard check */
            border-left: 4px solid #ef4444; /* Red border */
        }
        .tab-button.active {
            background-color: #dc2626 !important; /* Red 600 active tab */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">

        <!-- Header -->
        <header class="text-center mb-10 p-6 bg-white card border-b-4 border-red-600">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">
                TBM (작업 전 안전회의) 관리 도구
            </h1>
            <p class="text-lg text-gray-600">Tool Box Meeting Checklist & Supervisor Script</p>
        </header>
        
        <!-- TBM Conductor Info & Submission -->
        <section class="mb-10 p-6 bg-white card border-l-4 border-red-500">
            <h2 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">0. TBM 정보 입력 및 기록 제출</h2>
            <div class="flex flex-col sm:flex-row items-start sm:items-end gap-4 mb-4">
                <div class="flex-grow w-full">
                    <label for="supervisorName" class="block text-sm font-medium text-gray-700 mb-1">TBM 담당자 성명</label>
                    <input type="text" id="supervisorName" placeholder="예: 홍길동" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150" value="담당자">
                </div>
                <button id="submitTBM" class="w-full sm:w-auto px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 flex items-center justify-center shadow-lg active:shadow-none">
                    <span id="submitText">TBM 기록 제출</span>
                    <div id="loadingSpinner" class="loading-spinner hidden"></div>
                </button>
            </div>
            
            <div id="submitMessage" class="mt-4 p-3 rounded-lg text-center hidden"></div>
            
            <p class="text-xs text-gray-500 mt-2">※ 기록 제출 시 현재 점검 상태와 시각이 데이터베이스에 저장됩니다.</p>
        </section>

        <!-- TBM Checklist Section (General) -->
        <section class="mb-10 p-6 bg-white card">
            <h2 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">1. TBM 필수 체크리스트 (공통 점검 사항)</h2>
            <p class="text-sm text-gray-500 mb-4">모든 작업에 공통으로 적용되는 기본 안전 점검 사항입니다.</p>
            
            <ul id="tbmChecklistGeneral" class="space-y-3">
                <li class="general-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between transition duration-150 ease-in-out" data-item="1">
                    <span class="text-gray-700 font-medium">오늘의 작업 내용 및 절차 확인</span>
                    <span class="check-icon text-xl text-gray-400">☐</span>
                </li>
                <li class="general-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="2">
                    <span class="text-gray-700 font-medium">작업장 내 주요 위험 요소 공유 및 대책 논의</span>
                    <span class="check-icon text-xl text-gray-400">☐</span>
                </li>
                <li class="general-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="3">
                    <span class="text-gray-700 font-medium">개인 보호구(PPE) 착용 상태 및 적합성 점검</span>
                    <span class="check-icon text-xl text-gray-400">☐</span>
                </li>
                <li class="general-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="4">
                    <span class="text-gray-700 font-medium">비상 상황 발생 시 행동 요령 및 대피로 숙지</span>
                    <span class="check-icon text-xl text-gray-400">☐</span>
                </li>
                <li class="general-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="5">
                    <span class="text-gray-700 font-medium">작업 전 안전 점검표(PTW/Checklist) 작성 완료 확인</span>
                    <span class="check-icon text-xl text-gray-400">☐</span>
                </li>
                <li class="general-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="6">
                    <span class="text-gray-700 font-medium">작업 간 상호 감시 및 협력 강조</span>
                    <span class="check-icon text-xl text-gray-400">☐</span>
                </li>
                <li class="general-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="7">
                    <span class="text-gray-700 font-medium">작업자 컨디션 및 건강 상태 확인</span>
                    <span class="check-icon text-xl text-gray-400">☐</span>
                </li>
            </ul>

            <div id="completionMessageGeneral" class="mt-6 p-3 bg-green-100 text-green-800 rounded-lg text-center hidden">
                <span class="font-semibold">👍 모든 공통 TBM 항목 확인 완료!</span>
            </div>
        </section>

        <!-- Job-Specific Checklist Section -->
        <section class="mb-10 p-6 bg-white card">
            <h2 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">2. 작업 별 위험 요소 집중 점검표</h2>
            <p class="text-sm text-gray-500 mb-4">오늘의 작업을 선택하고 해당 위험 요소를 집중 점검하세요.</p>
            
            <!-- Job Type Tabs -->
            <div id="jobTabs" class="flex flex-wrap gap-2 mb-6">
                <button data-job="gas_flammable" class="tab-button px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-red-100 transition duration-150 active">가연성가스</button>
                <button data-job="gas_toxic" class="tab-button px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-red-100 transition duration-150">독성가스</button>
                <button data-job="hot_work" class="tab-button px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-red-100 transition duration-150">화기 취급</button>
                <button data-job="height" class="tab-button px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-red-100 transition duration-150">고소 작업</button>
                <button data-job="confined" class="tab-button px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-red-100 transition duration-150">밀폐지역</button>
                <button data-job="heavy_equip" class="tab-button px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-red-100 transition duration-150">중장비</button>
            </div>

            <!-- Job Checklist Content -->
            <div id="jobChecklistContent" class="space-y-4">
                
                <!-- 1. 가연성 가스 취급 작업 -->
                <ul id="checklist-gas_flammable" class="job-checklist space-y-3" data-job-name="가연성가스 취급">
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="flam_1">
                        <span class="text-gray-700 font-medium">가스 누설 감지기(Detector) 작동 상태 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="flam_2">
                        <span class="text-gray-700 font-medium">점화원(Ignition Source) 통제 조치 확인 (금연, 불꽃 방지)</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="flam_3">
                        <span class="text-gray-700 font-medium">충분한 강제 환기(Ventilation) 실시 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="flam_4">
                        <span class="text-gray-700 font-medium">비상 차단(E-Stop) 장치 위치 및 절차 숙지</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                </ul>

                <!-- 2. 독성 가스 취급 작업 -->
                <ul id="checklist-gas_toxic" class="job-checklist space-y-3 hidden" data-job-name="독성 가스 취급">
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="toxic_1">
                        <span class="text-gray-700 font-medium">호흡 보호구(방독면 등) 지급 및 올바른 착용 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="toxic_2">
                        <span class="text-gray-700 font-medium">작업 전/중 농도 측정 장비 작동 상태 및 계획 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="toxic_3">
                        <span class="text-gray-700 font-medium">긴급 제독 장비(Eye/Skin Wash) 위치 및 작동 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="toxic_4">
                        <span class="text-gray-700 font-medium">응급 환자 발생 시 후송 및 의료 대응 시스템 숙지</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                </ul>

                <!-- 3. 화기 취급 작업 -->
                <ul id="checklist-hot_work" class="job-checklist space-y-3 hidden" data-job-name="화기 취급">
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="hot_1">
                        <span class="text-gray-700 font-medium">화재 감시자(Fire Watcher) 배치 및 임무 교육 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="hot_2">
                        <span class="text-gray-700 font-medium">소화기 및 소화 설비 비치 및 사용 가능 상태 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="hot_3">
                        <span class="text-gray-700 font-medium">가연물 격리 및 용접 불티 비산 방지 조치(방화포) 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="hot_4">
                        <span class="text-gray-700 font-medium">작업 후 잔불 감시(Post-Hot Work) 계획 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                </ul>

                <!-- 4. 고소 작업 -->
                <ul id="checklist-height" class="job-checklist space-y-3 hidden" data-job-name="고소 작업">
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="height_1">
                        <span class="text-gray-700 font-medium">안전대(Fall Harness) 훅 체결 상태 및 체결 위치 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="height_2">
                        <span class="text-gray-700 font-medium">작업 발판, 비계, 안전난간의 견고성 및 설치 상태 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="height_3">
                        <span class="text-gray-700 font-medium">공구/자재 낙하 방지 조치(공구걸이, 그물망 등) 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="height_4">
                        <span class="text-gray-700 font-medium">승강 및 이동 시 안전 확보(3점 지지 등) 교육 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                </ul>
                
                <!-- 5. 밀폐지역 작업 -->
                <ul id="checklist-confined" class="job-checklist space-y-3 hidden" data-job-name="밀폐지역 작업">
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="conf_1">
                        <span class="text-gray-700 font-medium">산소/유해가스 농도 측정(Atmospheric Testing) 결과 확인 및 기록</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="conf_2">
                        <span class="text-gray-700 font-medium">환기(Ventilation) 실시 및 작업 중 지속적인 환기 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="conf_3">
                        <span class="text-gray-700 font-medium">감시자(Attendant) 배치 및 비상 연락 체계(Intercom 등) 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="conf_4">
                        <span class="text-gray-700 font-medium">비상 구조 장비(Tripod, Air Pack 등) 준비 완료 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                </ul>

                <!-- 6. 중장비 작업 -->
                <ul id="checklist-heavy_equip" class="job-checklist space-y-3 hidden" data-job-name="중장비 작업">
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="equip_1">
                        <span class="text-gray-700 font-medium">신호수(Signalman) 배치, 시야 확보 및 신호 체계 통일 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="equip_2">
                        <span class="text-gray-700 font-medium">장비 작업 전 일일 점검(Daily Check) 실시 기록 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="equip_3">
                        <span class="text-gray-700 font-medium">아웃리거 설치 여부 및 지반 침하 방지 조치 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                    <li class="job-checklist-item p-4 bg-gray-50 rounded-lg cursor-pointer flex items-center justify-between" data-item="equip_4">
                        <span class="text-gray-700 font-medium">작업 반경 내 통제선 설치 및 접근 금지 교육 확인</span>
                        <span class="check-icon text-xl text-gray-400">☐</span>
                    </li>
                </ul>

                <div id="completionMessageJob" class="mt-6 p-3 bg-red-100 text-red-800 rounded-lg text-center hidden">
                    <span class="font-semibold">⚠️ 현재 작업(<span id="currentJobName" class="font-extrabold"></span>) 집중 점검 완료!</span>
                </div>
            </div>
        </section>

        <!-- Supervisor Script Section -->
        <section class="p-6 bg-white card">
            <h2 class="text-2xl font-bold text-red-600 mb-4 border-b pb-2">3. TBM 관리자 (Supervisor) 스크립트</h2>
            <p class="text-sm text-gray-500 mb-4">TBM 진행 시 관리자가 참고할 수 있는 단계별 스크립트입니다. (작업 탭 선택에 따라 본론 내용이 변경됩니다)</p>

            <!-- Script Toggle Buttons -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button data-target="intro" class="script-toggle-btn px-4 py-2 bg-red-500 text-white font-semibold rounded-full hover:bg-red-700 transition duration-150">
                    1. 도입 (시작)
                </button>
                <button data-target="body" class="script-toggle-btn px-4 py-2 bg-gray-400 text-white font-semibold rounded-full hover:bg-gray-600 transition duration-150">
                    2. 본론 (위험 요소)
                </button>
                <button data-target="conclusion" class="script-toggle-btn px-4 py-2 bg-gray-400 text-white font-semibold rounded-full hover:bg-gray-600 transition duration-150">
                    3. 결론 (마무리)
                </button>
            </div>

            <!-- Script Content -->
            <div id="scriptContent" class="p-5 bg-gray-50 rounded-lg border-l-4 border-red-500 text-gray-700">
                <!-- Script content is dynamically loaded here -->
                <div id="script-intro" class="script-section">
                    <h3 class="text-xl font-bold mb-3 text-red-700">1. 도입 (TBM 시작)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg">인사 및 격려</p>
                        <p>
                            "모두 집합해 주셔서 감사합니다. 오늘의 TBM을 시작하겠습니다.
                            오늘도 안전하고 활기찬 하루를 만들기 위해 잠시 집중해 주시기 바랍니다.
                            어제도 무재해로 마무리해주신 모든 분께 감사드립니다."
                        </p>
                        <p class="font-bold text-lg">작업 개요</p>
                        <p>
                            "오늘 우리가 수행할 작업은 **[구체적인 작업 명칭 및 장소]**입니다.
                            주요 작업 내용은 **<span id="scriptJobName">가연성가스 취급</span>**이며,
                            예상 작업 시간은 **[시간]**입니다."
                        </p>
                    </div>
                </div>

                <div id="script-body" class="script-section hidden">
                    <!-- Dynamic Job-Specific Content will be inserted here -->
                </div>

                <div id="script-conclusion" class="script-section hidden">
                    <h3 class="text-xl font-bold mb-3 text-red-700">3. 결론 (작업 시작 및 마무리)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg">재강조 및 당부</p>
                        <p>
                            "안전은 그 누구도 아닌 우리 자신을 위한 것입니다. 작업 중 조금이라도 이상을 느끼거나 불안전한 상황을 목격하면,
                            주저하지 마시고 **즉시** 작업을 멈추고 저에게 보고해 주십시오."
                        </p>
                        <p class="font-bold text-lg">안전 구호 제창 및 시작 명령</p>
                        <p>
                            "마지막으로, 다 같이 안전 구호를 외치고 작업을 시작하겠습니다.
                            '오늘도 무재해!' (작업자 일동: '확인!')
                            좋습니다. 지금부터 안전 작업에 임해 주십시오. 감사합니다!"
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer for context -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>&copy; TBM 안전 관리 지원 도구. 모든 작업은 TBM 내용 숙지 후 시작해야 합니다.</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * ⚠️ GitHub Pages 배포를 위한 설정 안내 ⚠️
         * 이 코드를 GitHub Pages에 배포하려면, 아래 'STATIC_FIREBASE_CONFIG'에 
         * 사용자님의 실제 Firebase 프로젝트 설정 정보를 붙여넣어야 합니다.
         * Firebase Console > 프로젝트 설정 > 웹 앱에서 정보를 확인할 수 있습니다.
         */
        const STATIC_FIREBASE_CONFIG = {
            apiKey: "YOUR_API_KEY", // <-- 여기에 실제 API 키를 넣으세요
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", // <-- 여기에 Auth 도메인을 넣으세요
            projectId: "YOUR_PROJECT_ID", // <-- 여기에 프로젝트 ID를 넣으세요 (앱 ID로 사용됨)
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Check if the placeholder is replaced
        const isConfigValid = STATIC_FIREBASE_CONFIG.projectId !== "YOUR_PROJECT_ID";

        const firebaseConfig = isConfigValid ? STATIC_FIREBASE_CONFIG : null;
        
        // When deployed statically, we use the Project ID as the application ID for database path
        const appId = isConfigValid ? STATIC_FIREBASE_CONFIG.projectId : 'default-app-id'; 
        
        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId;

        // --- Job-Specific Script Content ---
        const jobScripts = {
            'gas_flammable': {
                title: "가연성가스 취급 작업",
                content: `
                    <h3 class="text-xl font-bold mb-3 text-red-700">2. 본론 (위험 요소 및 안전 절차)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg text-red-600">오늘의 핵심 위험 요소: 폭발 및 화재</p>
                        <p>
                            "가장 중요하게 인지해야 할 위험 요소는 **가스 누설로 인한 폭발 또는 화재**입니다.
                            이를 방지하기 위해 **가스 감지기 작동 상태**를 확인하고, **점화원 통제 조치** (금연, 불꽃 방지)를 철저히 준수해야 합니다."
                        </p>
                        <p>
                            "두 번째 위험 요소는 **밀폐된 공간에서의 가스 축적**입니다.
                            대책으로 **충분한 강제 환기**를 실시하고, **비상 차단 장치 위치**를 반드시 숙지해 주십시오."
                        </p>
                        <p class="font-bold text-lg">보호구 및 절차 확인</p>
                        <p>
                            "모두 **안전모, 안전화, 방폭 장갑** 착용 상태를 다시 한번 확인해 주십시오. 
                            특히, **비상 차단 및 소화 설비 위치**를 다시 한번 확인합니다."
                        </p>
                        <p class="font-bold text-lg">질의응답</p>
                        <p>"작업 내용, 위험 요소, 안전 절차에 대해 질문이나 우려 사항이 있으신 분은 지금 말씀해 주십시오."</p>
                    </div>
                `
            },
            'gas_toxic': {
                title: "독성 가스 취급 작업",
                content: `
                    <h3 class="text-xl font-bold mb-3 text-red-700">2. 본론 (위험 요소 및 안전 절차)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg text-red-600">오늘의 핵심 위험 요소: 질식 및 중독</p>
                        <p>
                            "가장 중요하게 인지해야 할 위험 요소는 **독성 가스 흡입으로 인한 중독 및 질식**입니다.
                            이를 방지하기 위해 **호흡 보호구(방독면)의 지급 및 올바른 착용**을 철저히 확인하고, 작업 전/중 **농도 측정**을 지속해야 합니다."
                        </p>
                        <p>
                            "두 번째 위험 요소는 **긴급 상황 발생 시 부적절한 대응**입니다.
                            대책으로 **긴급 제독 장비(Eye/Skin Wash)의 위치**를 확인하고, 응급 환자 발생 시 **후송 절차**를 숙지합니다."
                        </p>
                        <p class="font-bold text-lg">보호구 및 절차 확인</p>
                        <p>
                            "모두 **방독면(또는 송기마스크), 내화학성 보호복** 착용 상태를 다시 한번 확인해 주십시오. 
                            특히, **긴급 제독 장비** 위치를 다시 한번 확인합니다."
                        </p>
                        <p class="font-bold text-lg">질의응답</p>
                        <p>"작업 내용, 위험 요소, 안전 절차에 대해 질문이나 우려 사항이 있으신 분은 지금 말씀해 주십시오."</p>
                    </div>
                `
            },
            'hot_work': {
                title: "화기 취급 작업",
                content: `
                    <h3 class="text-xl font-bold mb-3 text-red-700">2. 본론 (위험 요소 및 안전 절차)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg text-red-600">오늘의 핵심 위험 요소: 화재 발생 및 비산</p>
                        <p>
                            "가장 중요하게 인지해야 할 위험 요소는 **용접 불티로 인한 화재 발생**입니다.
                            이를 방지하기 위해 **화재 감시자(Fire Watcher)**를 배치하고, **소화기**를 가까이에 비치하여 즉시 사용 가능한지 확인합니다."
                        </p>
                        <p>
                            "두 번째 위험 요소는 **가연물로의 불티 비산**입니다.
                            대책으로 **가연물 격리 및 방화포 설치**를 확인하고, 작업 종료 후 **잔불 감시**를 30분 이상 철저히 해 주십시오."
                        </p>
                        <p class="font-bold text-lg">보호구 및 절차 확인</p>
                        <p>
                            "모두 **용접면, 용접용 보안경, 가죽 장갑** 착용 상태를 다시 한번 확인해 주십시오. 
                            특히, **화재 감시자의 역할**을 다시 한번 상기합니다."
                        </p>
                        <p class="font-bold text-lg">질의응답</p>
                        <p>"작업 내용, 위험 요소, 안전 절차에 대해 질문이나 우려 사항이 있으신 분은 지금 말씀해 주십시오."</p>
                    </div>
                `
            },
            'height': {
                title: "고소 작업",
                content: `
                    <h3 class="text-xl font-bold mb-3 text-red-700">2. 본론 (위험 요소 및 안전 절차)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg text-red-600">오늘의 핵심 위험 요소: 추락 사고</p>
                        <p>
                            "가장 중요하게 인지해야 할 위험 요소는 **고소에서의 추락**입니다.
                            이를 방지하기 위해 **안전대(Fall Harness)의 훅 체결 상태**를 반드시 확인하고, 체결 위치가 견고한지 재차 점검해야 합니다."
                        </p>
                        <p>
                            "두 번째 위험 요소는 **공구 및 자재 낙하**입니다.
                            대책으로 **공구걸이**를 사용하고, 작업 발판, 비계, 안전난간의 **견고성 및 설치 상태**를 다시 한번 확인합니다."
                        </p>
                        <p class="font-bold text-lg">보호구 및 절차 확인</p>
                        <p>
                            "모두 **안전모(턱끈 필수), 안전대** 착용 상태를 다시 한번 확인해 주십시오. 
                            특히, **안전대 체결 상태**를 상호 확인해 주시기 바랍니다."
                        </p>
                        <p class="font-bold text-lg">질의응답</p>
                        <p>"작업 내용, 위험 요소, 안전 절차에 대해 질문이나 우려 사항이 있으신 분은 지금 말씀해 주십시오."</p>
                    </div>
                `
            },
            'confined': {
                title: "밀폐지역 작업",
                content: `
                    <h3 class="text-xl font-bold mb-3 text-red-700">2. 본론 (위험 요소 및 안전 절차)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg text-red-600">오늘의 핵심 위험 요소: 산소 결핍 및 유해가스</p>
                        <p>
                            "가장 중요하게 인지해야 할 위험 요소는 **산소 결핍 및 유해가스로 인한 의식 상실**입니다.
                            이를 방지하기 위해 **작업 전/중 농도 측정** 결과를 확인하고, **강제 환기**를 지속적으로 실시해야 합니다."
                        </p>
                        <p>
                            "두 번째 위험 요소는 **긴급 상황 시 구조 지연**입니다.
                            대책으로 **감시자(Attendant) 배치**와 **비상 연락 체계**를 확인하며, **비상 구조 장비**가 준비되었는지 점검합니다."
                        </p>
                        <p class="font-bold text-lg">보호구 및 절차 확인</p>
                        <p>
                            "모두 **산소/유해가스 측정기, 송기마스크** 착용 상태를 다시 한번 확인해 주십시오. 
                            특히, **감시자와의 연락 상태**를 확인합니다."
                        </p>
                        <p class="font-bold text-lg">질의응답</p>
                        <p>"작업 내용, 위험 요소, 안전 절차에 대해 질문이나 우려 사항이 있으신 분은 지금 말씀해 주십시오."</p>
                    </div>
                `
            },
            'heavy_equip': {
                title: "중장비 작업",
                content: `
                    <h3 class="text-xl font-bold mb-3 text-red-700">2. 본론 (위험 요소 및 안전 절차)</h3>
                    <div class="space-y-3 text-base leading-relaxed">
                        <p class="font-bold text-lg text-red-600">오늘의 핵심 위험 요소: 충돌 및 협착</p>
                        <p>
                            "가장 중요하게 인지해야 할 위험 요소는 **장비 운행 중 작업자와의 충돌 및 협착**입니다.
                            이를 방지하기 위해 **신호수(Signalman)**의 배치와 **명확한 신호 체계**를 통일하고, 운전자는 **시야 확보**에 집중해야 합니다."
                        </p>
                        <p>
                            "두 번째 위험 요소는 **장비 전도(넘어짐)**입니다.
                            대책으로 장비 작업 전 **일일 점검** 기록을 확인하고, **아웃리거 설치** 및 **작업 반경 내 통제선 설치**를 철저히 지켜주십시오."
                        </p>
                        <p class="font-bold text-lg">보호구 및 절차 확인</p>
                        <p>
                            "모두 **안전모, 안전화** 착용 상태를 다시 한번 확인해 주십시오. 
                            특히, **신호수의 위치와 신호 내용**을 다시 한번 확인합니다."
                        </p>
                        <p class="font-bold text-lg">질의응답</p>
                        <p>"작업 내용, 위험 요소, 안전 절차에 대해 질문이나 우려 사항이 있으신 분은 지금 말씀해 주십시오."</p>
                    </div>
                `
            }
        };
        // ---------------------------------------------


        // The dynamic environment variables are ignored in this GitHub deployment setup.
        // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Retry settings for fetch (exponential backoff not fully implemented here but included for robustness)
        const MAX_RETRIES = 3;

        async function initFirebase() {
            if (!isConfigValid) {
                console.error("Firebase config is missing or invalid. Please update STATIC_FIREBASE_CONFIG.");
                showMessage("error", "데이터베이스 연결 설정 누락: Firebase 설정을 업데이트하세요.", 'bg-red-200 text-red-800');
                return;
            }
            
            try {
                // setLogLevel('Debug'); // Enable this for verbose debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // For static hosting, we use Anonymous Authentication for simplicity 
                // as custom tokens are not available.
                await signInAnonymously(auth);

                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized successfully. User ID:", userId);
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                showMessage("error", "Firebase 초기화 실패. 콘솔과 설정을 확인하세요.", 'bg-red-200 text-red-800');
            }
        }
        
        function getChecklistData() {
            const generalItems = document.querySelectorAll('#tbmChecklistGeneral .general-checklist-item');
            const jobChecklists = document.querySelectorAll('.job-checklist');
            const supervisorName = document.getElementById('supervisorName').value.trim() || "미입력";
            const currentJobElement = document.querySelector('.job-checklist:not(.hidden)');
            const jobType = currentJobElement ? currentJobElement.id.replace('checklist-', '') : 'none';
            
            const generalChecks = {};
            generalItems.forEach(item => {
                const dataItem = item.getAttribute('data-item');
                generalChecks[dataItem] = item.classList.contains('checked');
            });
            
            const jobChecks = {};
            if (currentJobElement) {
                currentJobElement.querySelectorAll('.job-checklist-item').forEach(item => {
                    const dataItem = item.getAttribute('data-item');
                    jobChecks[dataItem] = item.classList.contains('checked');
                });
            }

            return {
                supervisorName,
                timestamp: Date.now(),
                jobType,
                generalChecks,
                jobChecks
            };
        }

        async function submitTBMRecord() {
            if (!db || !userId) {
                showMessage("error", "데이터베이스 연결 오류. 잠시 후 다시 시도해 주세요.", 'bg-red-200 text-red-800');
                return;
            }

            const data = getChecklistData();
            
            if (data.supervisorName === "미입력") {
                showMessage("error", "TBM 담당자 성명을 입력해 주세요.", 'bg-red-200 text-red-800');
                document.getElementById('supervisorName').focus();
                return;
            }

            // Database path: /artifacts/{appId}/users/{userId}/tbm_records
            const collectionPath = `/artifacts/${appId}/users/${userId}/tbm_records`;
            const submitButton = document.getElementById('submitTBM');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');

            submitButton.disabled = true;
            submitText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            try {
                const docRef = await addDoc(collection(db, collectionPath), data);
                showMessage("success", `TBM 기록이 성공적으로 제출되었습니다. (ID: ${docRef.id.substring(0, 8)})`, 'bg-green-200 text-green-800');
            } catch (error) {
                console.error("Error submitting TBM record:", error);
                showMessage("error", "기록 제출 중 오류가 발생했습니다. 콘솔을 확인해 주세요.", 'bg-yellow-200 text-yellow-800');
            } finally {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
        
        function showMessage(type, message, classes) {
            const msgElement = document.getElementById('submitMessage');
            msgElement.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-yellow-200', 'text-yellow-800');
            
            if (classes) {
                msgElement.className = classes + ' mt-4 p-3 rounded-lg text-center';
            } else if (type === 'success') {
                msgElement.className = 'mt-4 p-3 rounded-lg text-center bg-green-200 text-green-800';
            } else {
                 msgElement.className = 'mt-4 p-3 rounded-lg text-center bg-red-200 text-red-800';
            }
            msgElement.textContent = message;
        }


        // --- DOM Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            document.getElementById('submitTBM').addEventListener('click', submitTBMRecord);
            
            const checklistGeneral = document.getElementById('tbmChecklistGeneral');
            const completionMessageGeneral = document.getElementById('completionMessageGeneral');
            const jobTabs = document.querySelectorAll('#jobTabs .tab-button');
            const jobChecklists = document.querySelectorAll('.job-checklist');
            const completionMessageJob = document.getElementById('completionMessageJob');
            const currentJobNameSpan = document.getElementById('currentJobName');
            const scriptToggleButtons = document.querySelectorAll('.script-toggle-btn');
            const scriptSections = document.querySelectorAll('.script-section');
            const scriptJobNameSpan = document.getElementById('scriptJobName');
            const scriptBodyDiv = document.getElementById('script-body');

            let currentJobId = 'gas_flammable'; // Default active job

            // --- 1. General Checklist Interaction ---
            checklistGeneral.addEventListener('click', (event) => {
                let item = event.target.closest('.general-checklist-item');
                if (item) {
                    toggleChecklistItem(item, 'general');
                    checkCompletionStatusGeneral();
                }
            });

            function toggleChecklistItem(item, type) {
                item.classList.toggle('checked');
                
                const isChecked = item.classList.contains('checked');
                const checkIcon = item.querySelector('.check-icon');

                if (isChecked) {
                    checkIcon.textContent = '✔';
                    checkIcon.classList.remove('text-gray-400');
                    item.classList.remove('bg-gray-50');
                    if (type === 'general') {
                        checkIcon.classList.add('text-green-600');
                        item.classList.add('bg-green-100');
                    } else {
                        checkIcon.classList.add('text-red-600');
                        item.classList.add('bg-red-100');
                    }
                } else {
                    checkIcon.textContent = '☐';
                    checkIcon.classList.add('text-gray-400');
                    checkIcon.classList.remove('text-green-600', 'text-red-600');
                    item.classList.add('bg-gray-50');
                    item.classList.remove('bg-green-100', 'bg-red-100');
                }
            }

            function checkCompletionStatusGeneral() {
                const totalItems = checklistGeneral.querySelectorAll('.general-checklist-item').length;
                const checkedItems = checklistGeneral.querySelectorAll('.general-checklist-item.checked').length;

                if (totalItems === checkedItems) {
                    completionMessageGeneral.classList.remove('hidden');
                } else {
                    completionMessageGeneral.classList.add('hidden');
                }
            }

            // --- 2. Job-Specific Checklist Interaction ---
            jobChecklists.forEach(list => {
                list.addEventListener('click', (event) => {
                    let item = event.target.closest('.job-checklist-item');
                    if (item) {
                        toggleChecklistItem(item, 'job');
                        checkCompletionStatusJob(list.id);
                    }
                });
            });
            
            function checkCompletionStatusJob(listId) {
                const list = document.getElementById(listId);
                if (!list) return;

                const totalItems = list.querySelectorAll('.job-checklist-item').length;
                const checkedItems = list.querySelectorAll('.job-checklist-item.checked').length;
                
                currentJobNameSpan.textContent = list.dataset.jobName;

                if (totalItems > 0 && totalItems === checkedItems) {
                    completionMessageJob.classList.remove('hidden');
                } else {
                    completionMessageJob.classList.add('hidden');
                }
            }

            // --- 3. Job Tab Switching ---
            jobTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetJob = e.target.dataset.job;
                    currentJobId = targetJob;
                    const jobName = document.getElementById(`checklist-${targetJob}`).dataset.jobName;

                    // Update button active state
                    jobTabs.forEach(b => {
                        b.classList.remove('active', 'bg-red-500', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    e.target.classList.add('active', 'bg-red-500', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'text-gray-700');

                    // Switch checklist content
                    jobChecklists.forEach(list => list.classList.add('hidden'));
                    const targetList = document.getElementById(`checklist-${targetJob}`);
                    if (targetList) {
                        targetList.classList.remove('hidden');
                        checkCompletionStatusJob(targetList.id); // Re-check completion for the newly visible tab
                    }

                    // Update Script Content for the selected job
                    updateScriptContent(currentJobId, jobName);

                    // If 'Body' script is currently active, re-render it
                    if (!document.getElementById('script-body').classList.contains('hidden')) {
                        setActiveSection('body');
                    }
                });
            });

            // Function to update script based on selected job
            function updateScriptContent(jobId, jobName) {
                // Update Intro Section job name
                scriptJobNameSpan.textContent = jobName;

                // Update Body Section content
                const scriptData = jobScripts[jobId];
                if (scriptData) {
                    scriptBodyDiv.innerHTML = scriptData.content;
                }
            }


            // --- 4. Supervisor Script Toggle Interaction ---
            function setActiveSection(targetId) {
                scriptSections.forEach(section => section.classList.add('hidden'));
                document.getElementById(`script-${targetId}`).classList.remove('hidden');

                scriptToggleButtons.forEach(button => {
                    if (button.dataset.target === targetId) {
                        button.classList.remove('bg-gray-400', 'hover:bg-gray-600');
                        button.classList.add('bg-red-500', 'hover:bg-red-700');
                    } else {
                        button.classList.add('bg-gray-400', 'hover:bg-gray-600');
                        button.classList.remove('bg-red-500', 'hover:bg-red-700');
                    }
                });

                const scriptCard = document.querySelector('#scriptContent');
                if (scriptCard) {
                    scriptCard.classList.remove('border-l-4', 'border-red-500', 'border-red-600', 'border-green-600');
                    
                    if (targetId === 'intro') scriptCard.classList.add('border-red-500');
                    if (targetId === 'body') scriptCard.classList.add('border-red-600'); 
                    if (targetId === 'conclusion') scriptCard.classList.add('border-green-600');
                }
            }

            scriptToggleButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    setActiveSection(e.target.dataset.target);
                });
            });

            // Initial setup on load
            setActiveSection('intro'); // Script default
            // Trigger click on the default job tab to initialize checklists and script content
            document.querySelector(`[data-job="${currentJobId}"]`).click(); 
        });
    </script>

</body>
</html>
